<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="order">
	<insert id="orderInsert" parameterType="map">
		INSERT INTO ORDERS
		(ORDER_ID, USER_ID, ALBUM_ID,
		ORDER_DATE,TOTAL,O_QUANTITY)
		VALUES
		((SELECT CASE WHEN SUBSTR((SELECT MAX(ORDER_ID) FROM ORDERS),0,6) =
		TO_CHAR(SYSDATE,'YYMMDD')
		THEN TO_CHAR(SYSDATE,'YYMMDD') || 'N' ||
		LPAD(SUBSTR((SELECT MAX(ORDER_ID)
		FROM ORDERS),-4)+1,4,'0')
		ELSE
		TO_CHAR(SYSDATE,'YYMMDD') || 'N' ||'0001'
		END FROM DUAL)
		,
		#{userId},#{albumId} ,SYSDATE, (SELECT I.ALBUM_PRICE * #{oQuantity}
		FROM INVENTORY I, ALBUM A
		WHERE I.ALBUM_ID = A.ALBUM_ID AND A.ALBUM_ID
		= #{albumId}) ,#{oQuantity})
	</insert>
	
	<!-- UserId로 ordersVo 불러오기 -->
	<select id="selectAllOrdersByUserId" parameterType="String"
		resultType="OrdersVo">
		SELECT
		ORDER_ID as orderId, USER_ID as userId,
		ALBUM_ID as
		albumId, ORDER_DATE as orderDate,
		TOTAL, O_QUANTITY as oQuantity
		FROM
		ORDERS
		WHERE
		USER_ID = #{value}
	</select>
	<select id="selectAllOrders" resultType="OrdersVo">
		SELECT
		ORDER_ID as
		orderId, USER_ID as userId,
		ALBUM_ID as albumId, ORDER_DATE as
		orderDate,
		TOTAL, O_QUANTITY as oQuantity
		FROM
		ORDERS
	</select>
	<select id="selectByOrderId" parameterType="String"
		resultType="OrdersVo">
		SELECT
		ORDER_ID as orderId, USER_ID as userId,
		ALBUM_ID as
		albumId, ORDER_DATE as orderDate,
		TOTAL, O_QUANTITY as oQuantity
		FROM
		ORDERS
		WHERE
		ORDER_ID = #{value}
	</select>

	<select id="searchOrders" parameterType="hashmap"
		resultType="OrdersVo">
		SELECT O.ORDER_ID as orderId,
		U.USER_NAME as userName,O.ORDER_DATE as orderDate,O.O_QUANTITY as oQuantity,S.SHIPMENT_STATUS as status,O.TOTAL as total
		FROM USERS U JOIN ORDERS O
		ON U.USER_ID = O.USER_ID
		JOIN SHIPMENTS S ON O.ORDER_ID=S.ORDER_ID
		WHERE U.USER_NAME LIKE CONCAT('%', #{keyword}, '%') or
        O.ORDER_ID LIKE CONCAT('%', #{keyword}, '%') 
	</select>
</mapper>